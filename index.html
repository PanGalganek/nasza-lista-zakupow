<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Laboratorium</title>
    <link rel="manifest" href="manifest.json">
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .ordered-row { background-color: #f0fdf4 !important; }
        .active-tab { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: bold; }
        .active-month { background-color: #9333ea !important; color: white !important; border-color: #9333ea !important; }
        .active-sub-tab-odczynniki { background-color: #eff6ff !important; color: #2563eb !important; border-color: #2563eb !important; border-width: 2px !important; }
        .active-sub-tab-woda { background-color: #eff6ff !important; color: #2563eb !important; border-color: #2563eb !important; border-width: 2px !important; }
        .active-sub-tab-scieki { background-color: #f0fdf4 !important; color: #16a34a !important; border-color: #16a34a !important; border-width: 2px !important; }
        .task-done { opacity: 0.6; background-color: #f9fafb; }
        .editing-mode { border: 2px solid #2563eb !important; background-color: #eff6ff !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-1 md:p-8 flex items-center justify-center">

<!-- ===================== POMINIĘTE: login / UI (BEZ ZMIAN) ===================== -->

<script type="module">
/* ===================== BEZ ZMIAN: firebase init ===================== */

/* ===================== NOWA FUNKCJA – TYLKO DO DNI ROBOCZYCH ===================== */
function countWorkingDays(from, to) {
    let count = 0;
    const current = new Date(from);
    const end = new Date(to);

    while (current <= end) {
        const day = current.getDay();
        if (day !== 0 && day !== 6) count++;
        current.setDate(current.getDate() + 1);
    }
    return count;
}

/* ===================== ODCZYNNIKI ===================== */
function renderOdczynniki() {
    const container = document.getElementById('chemicalListGrouped');
    container.innerHTML = "";
    const ab = document.getElementById('alertBox');
    ab.innerHTML = "";

    const filtered = odczynnikiCache.filter(item =>
        (item.category || 'Wzorce') === currentOdczynnikiSubTab
    );

    const groups = filtered.reduce((acc, item) => {
        const prefix = (item.group || 'Inne').split('/')[0];
        if (!acc[prefix]) acc[prefix] = { prefix, items: [], name: item.name };
        acc[prefix].items.push(item);
        return acc;
    }, {});

    let groupAlerts = [];

    Object.values(groups).forEach(group => {
        const expiringItems = group.items.filter(item => {
            if (!item.expiry) return false;

            const today = new Date();
            const expiry = new Date(item.expiry);

            if (currentOdczynnikiSubTab === 'Odczynniki') {
                const wd = countWorkingDays(today, expiry);
                return wd >= 0 && wd <= 60;
            } else {
                const diff = Math.ceil((expiry - today) / 86400000);
                return diff >= 0 && diff <= 30;
            }
        });

        if (expiringItems.length > 0) {
            const anyOrdered = expiringItems.some(i => i.ordered);
            groupAlerts.push({
                prefix: group.prefix,
                name: group.name,
                type: anyOrdered ? 'ordered' : 'warning'
            });
        }
    });

    if (groupAlerts.length > 0) {
        ab.innerHTML = groupAlerts.map(a =>
            `<div class="bg-orange-100 border border-orange-200 text-orange-800 p-2 rounded font-bold">
                ⚠️ [${a.prefix}] ${a.name}
            </div>`
        ).join('');
        ab.classList.remove('hidden');
    } else {
        ab.classList.add('hidden');
    }
}
</script>
</body>
</html>
