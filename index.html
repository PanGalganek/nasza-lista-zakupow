<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>e-Laboratorium</title>
    <link rel="manifest" href="manifest.json">
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .ordered-row { background-color: #f0fdf4 !important; }
        .active-tab { border-bottom: 4px solid #2563eb; color: #2563eb; font-weight: bold; }
        .active-month { background-color: #9333ea !important; color: white !important; border-color: #9333ea !important; }
        .active-sub-tab-odczynniki { background-color: #eff6ff !important; color: #2563eb !important; border-color: #2563eb !important; border-width: 2px !important; }
        .active-sub-tab-woda { background-color: #eff6ff !important; color: #2563eb !important; border-color: #2563eb !important; border-width: 2px !important; }
        .active-sub-tab-scieki { background-color: #f0fdf4 !important; color: #16a34a !important; border-color: #16a34a !important; border-width: 2px !important; }
        .task-done { opacity: 0.6; background-color: #f9fafb; }
        .editing-mode { border: 2px solid #2563eb !important; background-color: #eff6ff !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 45px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: 1px solid #f3f4f6; position: relative; }
        .calendar-day.today { border: 2px solid #2563eb; font-weight: bold; color: #2563eb; }
        .calendar-day.selected { background-color: #eff6ff; border-color: #bfdbfe; }
        .has-event::after { content: ''; width: 5px; height: 5px; background-color: #2563eb; border-radius: 50%; position: absolute; bottom: 5px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-1 md:p-8 flex items-center justify-center">

    <div id="loginSection" class="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">üß™ e-Lab</h2>
        <input type="email" id="loginEmail" placeholder="E-mail" class="w-full border p-3 rounded mb-4 outline-none focus:ring-2 focus:ring-blue-500">
        <input type="password" id="loginPassword" placeholder="Has≈Ço" class="w-full border p-3 rounded mb-6 outline-none focus:ring-2 focus:ring-blue-500">
        <button onclick="handleLogin()" class="w-full bg-blue-600 text-white font-bold py-3 rounded shadow-lg">Zaloguj</button>
    </div>

    <div id="appSection" class="hidden max-w-6xl w-full bg-white rounded-xl shadow-lg p-2 md:p-6 self-start text-black">
        <div class="flex justify-between items-center mb-4 px-2">
            <h1 class="text-lg font-bold text-gray-800">‚öóÔ∏è e-Lab</h1>
            <button onclick="handleLogout()" class="text-[10px] text-red-500 font-bold uppercase">Wyloguj</button>
        </div>

        <div class="flex border-b mb-4 bg-gray-50 rounded-t-lg overflow-x-auto no-scrollbar">
            <button id="btnOdczynniki" onclick="switchTab('odczynniki')" class="flex-1 px-3 py-3 text-[10px] uppercase active-tab">üß™ Odczynniki</button>
            <button id="btnWoda" onclick="switchTab('woda')" class="flex-1 px-3 py-3 text-[10px] uppercase text-gray-400">üíß Woda</button>
            <button id="btnScieki" onclick="switchTab('scieki')" class="flex-1 px-3 py-3 text-[10px] uppercase text-gray-400">‚ò£Ô∏è ≈öcieki</button>
            <button id="btnWzorcowanie" onclick="switchTab('wzorcowanie')" class="flex-1 px-3 py-3 text-[10px] uppercase text-gray-400">üìè Sprzƒôt</button>
            <button id="btnKalendarz" onclick="switchTab('kalendarz')" class="flex-1 px-3 py-3 text-[10px] uppercase text-gray-400">üìÖ Kalendarz</button>
        </div>

        <div id="tabContentOdczynniki" class="block">
            <div class="flex gap-1 overflow-x-auto no-scrollbar pb-2 mb-4 border-b">
                <button onclick="switchOdczynnikiSubTab('Wzorce')" id="subBtnOdczynnikiWzorce" class="px-4 py-2 border rounded text-[9px] font-bold uppercase whitespace-nowrap active-sub-tab-odczynniki">üéØ Wzorce</button>
                <button onclick="switchOdczynnikiSubTab('Odczynniki')" id="subBtnOdczynnikiOdczynniki" class="px-4 py-2 border rounded text-[9px] font-bold uppercase bg-white text-gray-500 whitespace-nowrap">üì¶ Odczynniki</button>
            </div>
            <div id="alertBox" class="hidden mb-4 text-[10px] text-left space-y-1"></div>
            <div id="formContainer" class="bg-blue-50 p-4 rounded-lg mb-6 shadow-inner border border-blue-100 text-sm text-left">
                <input type="hidden" id="editId" value="">
                <div id="dynamicItemsContainer" class="space-y-4"></div>
                <div class="flex flex-col gap-3 mt-6 pt-4 border-t border-blue-200">
                    <button onclick="addFormRow()" class="w-full py-2 border-2 border-dashed border-blue-400 text-blue-600 font-bold rounded-lg text-[10px] uppercase">+ Dodaj kolejnƒÖ pozycjƒô</button>
                    <div class="flex gap-2">
                        <button id="submitBtn" onclick="addItem()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-lg text-sm uppercase shadow-md">Zapisz wszystko</button>
                        <button id="cancelEditBtn" onclick="cancelEdit()" class="hidden bg-gray-400 text-white font-bold py-3 px-6 rounded-lg uppercase">Anuluj</button>
                    </div>
                </div>
            </div>
            <div id="chemicalListGrouped" class="space-y-4"></div>
        </div>

        <div id="tabContentWoda" class="hidden space-y-4 text-left">
            <div class="flex gap-1 overflow-x-auto no-scrollbar pb-2 mb-2 border-b">
                <button onclick="switchSubTab('woda', 'Archiwalna')" id="subBtnWodaArchiwalna" class="px-2 py-2 border rounded text-[9px] font-bold uppercase whitespace-nowrap active-sub-tab-woda">üì¶ Archiwalna</button>
                <button onclick="switchSubTab('woda', 'Slepa')" id="subBtnWodaSlepa" class="px-2 py-2 border rounded text-[9px] font-bold uppercase bg-white text-gray-500 whitespace-nowrap">‚ö™ ≈ölepa</button>
                <button onclick="switchSubTab('woda', 'Probkobranie')" id="subBtnWodaProbkobranie" class="px-2 py-2 border rounded text-[9px] font-bold uppercase bg-white text-gray-500 whitespace-nowrap">üß∫ Pr√≥bkobranie</button>
                <button onclick="switchSubTab('woda', 'Porownania')" id="subBtnWodaPorownania" class="px-2 py-2 border rounded text-[9px] font-bold uppercase bg-white text-gray-500 whitespace-nowrap text-center min-w-[120px]">ü§ù Por√≥wnanie wewnƒÖtrzlaboratoryjne</button>
            </div>
            <div id="subContentWodaArchiwalna" class="space-y-4">
                <div id="mStatusWodaArchiwalna" class="p-2 rounded-lg text-[9px] font-bold border text-center"></div><div id="yStatusWodaArchiwalna" class="p-2 rounded-lg text-[9px] font-bold border text-center bg-white uppercase"></div>
                <div class="flex gap-2 mb-3"><input type="text" id="taskInputWodaArchiwalna" placeholder="Oznaczenie" class="flex-1 border p-2 rounded text-sm"><button onclick="addTask('woda', 'Archiwalna')" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">+</button></div><div id="taskListWodaArchiwalna" class="space-y-2"></div>
            </div>
            <div id="subContentWodaSlepa" class="hidden space-y-4"><div id="mStatusWodaSlepa" class="p-2 rounded-lg text-[9px] font-bold border text-center"></div><div id="yStatusWodaSlepa" class="p-2 rounded-lg text-[9px] font-bold border text-center bg-white uppercase"></div><div class="flex gap-2 mb-3"><input type="text" id="taskInputWodaSlepa" placeholder="Oznaczenie" class="flex-1 border p-2 rounded text-sm"><button onclick="addTask('woda', 'Slepa')" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">+</button></div><div id="taskListWodaSlepa" class="space-y-2"></div></div>
            <div id="subContentWodaProbkobranie" class="hidden space-y-4"><div id="mStatusWodaProbkobranie" class="p-2 rounded-lg text-[9px] font-bold border text-center"></div><div id="yStatusWodaProbkobranie" class="p-2 rounded-lg text-[9px] font-bold border text-center bg-white uppercase"></div><div class="flex gap-2 mb-3"><input type="text" id="taskInputWodaProbkobranie" placeholder="Miejsce" class="flex-1 border p-2 rounded text-sm"><button onclick="addTask('woda', 'Probkobranie')" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">+</button></div><div id="taskListWodaProbkobranie" class="space-y-2"></div></div>
            <div id="subContentWodaPorownania" class="hidden space-y-4"><div id="mStatusWodaPorownania" class="p-2 rounded-lg text-[9px] font-bold border text-center"></div><div id="yStatusWodaPorownania" class="p-2 rounded-lg text-[9px] font-bold border text-center bg-white uppercase"></div><div class="flex gap-2 mb-3"><input type="text" id="taskInputWodaPorownania" placeholder="Parametr por√≥w. wewnƒÖtrzlaboratoryjnego" class="flex-1 border p-2 rounded text-sm"><button onclick="addTask('woda', 'Porownania')" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">+</button></div><div id="taskListWodaPorownania" class="space-y-2"></div></div>
        </div>

        <div id="tabContentScieki" class="hidden space-y-4 text-left">
            <div class="flex gap-1 overflow-x-auto no-scrollbar pb-2 mb-2 border-b">
                <button onclick="switchSubTab('scieki', 'Archiwalna')" id="subBtnSciekiArchiwalna" class="px-2 py-2 border rounded text-[9px] font-bold uppercase whitespace-nowrap active-sub-tab-scieki">üì¶ Archiwalna</button>
                <button onclick="switchSubTab('scieki', 'Slepa')" id="subBtnSciekiSlepa" class="px-2 py-2 border rounded text-[9px] font-bold uppercase bg-white text-gray-500 whitespace-nowrap">‚ö™ ≈ölepa</button>
                <button onclick="switchSubTab('scieki', 'Probkobranie')" id="subBtnSciekiProbkobranie" class="px-2 py-2 border rounded text-[9px] font-bold uppercase bg-white text-gray-500 whitespace-nowrap">üß∫ Pr√≥bkobranie</button>
                <button onclick="switchSubTab('scieki', 'Porownania')" id="subBtnSciekiPorownania" class="px-2 py-2 border rounded text-[9px] font-bold uppercase bg-white text-gray-500 whitespace-nowrap text-center min-w-[120px]">ü§ù Por√≥wnanie wewnƒÖtrzlaboratoryjne</button>
            </div>
            <div id="subContentSciekiArchiwalna" class="space-y-4"><div id="mStatusSciekiArchiwalna" class="p-2 rounded-lg text-[9px] font-bold border text-center"></div><div id="yStatusSciekiArchiwalna" class="p-2 rounded-lg text-[9px] font-bold border text-center bg-white uppercase"></div><div class="flex gap-2 mb-3"><input type="text" id="taskInputSciekiArchiwalna" placeholder="Oznaczenie" class="flex-1 border p-2 rounded text-sm"><button onclick="addTask('scieki', 'Archiwalna')" class="bg-green-600 text-white px-4 py-2 rounded font-bold">+</button></div><div id="taskListSciekiArchiwalna" class="space-y-2"></div></div>
            <div id="subContentSciekiSlepa" class="hidden space-y-4"><div id="mStatusSciekiSlepa" class="p-2 rounded-lg text-[9px] font-bold border text-center"></div><div id="yStatusSciekiSlepa" class="p-2 rounded-lg text-[9px] font-bold border text-center bg-white uppercase"></div><div class="flex gap-2 mb-3"><input type="text" id="taskInputSciekiSlepa" placeholder="Oznaczenie" class="flex-1 border p-2 rounded text-sm"><button onclick="addTask('scieki', 'Slepa')" class="bg-green-600 text-white px-4 py-2 rounded font-bold">+</button></div><div id="taskListSciekiSlepa" class="space-y-2"></div></div>
            <div id="subContentSciekiProbkobranie" class="hidden space-y-4"><div id="mStatusSciekiProbkobranie" class="p-2 rounded-lg text-[9px] font-bold border text-center"></div><div id="yStatusSciekiProbkobranie" class="p-2 rounded-lg text-[9px] font-bold border text-center bg-white uppercase"></div><div class="flex gap-2 mb-3"><input type="text" id="taskInputSciekiProbkobranie" placeholder="Miejsce" class="flex-1 border p-2 rounded text-sm"><button onclick="addTask('scieki', 'Probkobranie')" class="bg-green-600 text-white px-4 py-2 rounded font-bold">+</button></div><div id="taskListSciekiProbkobranie" class="space-y-2"></div></div>
            <div id="subContentSciekiPorownania" class="hidden space-y-4"><div id="mStatusSciekiPorownania" class="p-2 rounded-lg text-[9px] font-bold border text-center"></div><div id="yStatusSciekiPorownania" class="p-2 rounded-lg text-[9px] font-bold border text-center bg-white uppercase"></div><div class="flex gap-2 mb-3"><input type="text" id="taskInputSciekiPorownania" placeholder="Parametr por√≥w. wewnƒÖtrzlaboratoryjnego" class="flex-1 border p-2 rounded text-sm"><button onclick="addTask('scieki', 'Porownania')" class="bg-green-600 text-white px-4 py-2 rounded font-bold">+</button></div><div id="taskListSciekiPorownania" class="space-y-2"></div></div>
        </div>

        <div id="tabContentWzorcowanie" class="hidden space-y-4 text-left">
            <div id="upcomingWzorcowanieAlert" class="hidden p-3 rounded-lg border bg-orange-100 border-orange-300 text-orange-900 text-[10px] font-extrabold mb-2"></div>
            <div class="flex overflow-x-auto gap-1 pb-2 no-scrollbar" id="monthsNav"></div>
            <div id="monthlyWzorcowanieCounter" class="p-3 rounded-lg text-[11px] font-bold text-center border uppercase"></div>
            <div id="formWzorcowanie" class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <input type="hidden" id="editIdEquip"><div class="grid grid-cols-1 gap-2"><input type="text" id="equipName" placeholder="Nazwa sprzƒôtu" class="border p-2 rounded text-sm text-black"><div class="grid grid-cols-2 gap-2"><select id="equipType" class="border p-2 rounded text-sm bg-white text-black"><option value="Wzorcowanie">Wzorcowanie</option><option value="Sprawdzenie">Sprawdzenie</option><option value="Kalibracja">Kalibracja</option></select><select id="equipMonth" class="border p-2 rounded text-sm bg-white text-black"><option value="01">Stycze≈Ñ</option><option value="02">Luty</option><option value="03">Marzec</option><option value="04">Kwiecie≈Ñ</option><option value="05">Maj</option><option value="06">Czerwiec</option><option value="07">Lipiec</option><option value="08">Sierpie≈Ñ</option><option value="09">Wrzesie≈Ñ</option><option value="10">Pa≈∫dziernik</option><option value="11">Listopad</option><option value="12">Grudzie≈Ñ</option></select></div><div class="flex gap-2"><button onclick="addEquipment()" class="flex-1 bg-purple-600 text-white py-2 rounded font-bold text-sm">Zapisz / Dodaj</button><button onclick="cancelEditEquip()" id="cancelEquipBtn" class="hidden bg-gray-400 text-white px-4 py-2 rounded">‚úï</button></div></div>
            </div>
            <div id="equipmentList" class="space-y-2"></div>
        </div>

        <div id="tabContentKalendarz" class="hidden space-y-4 text-left">
            <div class="bg-white border rounded-xl shadow-sm p-4 text-black">
                <div class="flex justify-between items-center mb-4"><button onclick="changeMonth(-1)" class="p-2 text-blue-600 font-bold text-lg">‚Üê</button><h2 id="calendarMonthYear" class="font-bold text-gray-800 uppercase tracking-widest text-sm text-center"></h2><button onclick="changeMonth(1)" class="p-2 text-blue-600 font-bold text-lg">‚Üí</button></div>
                <div class="calendar-grid text-center font-bold text-[9px] text-gray-400 mb-2"><div>PON</div><div>WT</div><div>≈öR</div><div>CZW</div><div>PT</div><div class="text-red-300">SOB</div><div class="text-red-300">NDZ</div></div>
                <div id="calendarDays" class="calendar-grid"></div>
            </div>
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-black">
                <div class="flex justify-between items-center mb-3"><h3 id="selectedDateLabel" class="text-[10px] font-bold text-blue-800 uppercase italic">Plan dnia</h3><button onclick="openAddEvent()" class="bg-blue-600 text-white px-3 py-1 rounded text-[10px] font-bold">+ DODAJ</button></div>
                <div id="dayEventsList" class="space-y-2"></div>
            </div>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-black">
                <h3 class="text-[10px] font-bold text-gray-600 uppercase mb-3 border-b pb-1">Wydarzenia w miesiƒÖcu</h3>
                <div id="monthEventsList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyANS8FT-mgc8D1kR-WXlhzjEvufveMMeM8", authDomain: "nasza-lista-zakupow.firebaseapp.com", projectId: "nasza-lista-zakupow", storageBucket: "nasza-lista-zakupow.firebasestorage.app", messagingSenderId: "516283526174", appId: "1:516283526174:web:f42c9c38333e821da5520f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let odczynnikiCache = [], currentOdczynnikiSubTab = 'Wzorce', formRowCount = 0;
        let selectedWMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
        let calDate = new Date(), selectedDayStr = new Date().toISOString().split('T')[0];
        let eventsCache = [], wzorcowanieCache = [];

        window.switchTab = (target) => {
            ['odczynniki', 'woda', 'scieki', 'wzorcowanie', 'kalendarz'].forEach(t => {
                const c = document.getElementById(`tabContent${t.charAt(0).toUpperCase() + t.slice(1)}`);
                const b = document.getElementById(`btn${t.charAt(0).toUpperCase() + t.slice(1)}`);
                if(c) c.classList.add('hidden');
                if(b) { b.classList.remove('active-tab'); b.classList.add('text-gray-400'); }
            });
            const contentEl = document.getElementById(`tabContent${target.charAt(0).toUpperCase() + target.slice(1)}`);
            if(contentEl) contentEl.classList.remove('hidden');
            const btnEl = document.getElementById(`btn${target.charAt(0).toUpperCase() + target.slice(1)}`);
            if(btnEl) btnEl.classList.add('active-tab');
            if(target === 'kalendarz') renderCalendar();
            if(target === 'wzorcowanie') updateWzorcowanieUI();
        };

        function calculateBusinessDays(startDate, endDate) {
            let count = 0;
            let curDate = new Date(startDate.getTime());
            curDate.setHours(0,0,0,0);
            const end = new Date(endDate);
            end.setHours(0,0,0,0);
            if (curDate > end) return -1;
            while (curDate <= end) {
                const dayOfWeek = curDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) count++;
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        }

        window.switchOdczynnikiSubTab = (target) => {
            currentOdczynnikiSubTab = target;
            ['Wzorce', 'Odczynniki'].forEach(sub => {
                const btn = document.getElementById(`subBtnOdczynniki${sub}`);
                if(btn) btn.className = `px-4 py-2 border rounded text-[9px] font-bold uppercase whitespace-nowrap ${target === sub ? 'active-sub-tab-odczynniki' : 'bg-white text-gray-500'}`;
            });
            renderOdczynniki();
        };

        window.addFormRow = (data = null) => {
            formRowCount++;
            const container = document.getElementById('dynamicItemsContainer');
            const row = document.createElement('div');
            row.id = `formRow_${formRowCount}`;
            row.className = "p-4 bg-white rounded-lg border border-blue-200 shadow-sm space-y-3 relative animate-fadeIn text-black";
            const today = new Date().toISOString().split('T')[0];
            row.innerHTML = `<div class="flex justify-between items-center border-b pb-1 text-black"><span class="text-[9px] font-bold text-blue-400 uppercase">Pozycja #${formRowCount}</span>${formRowCount > 1 ? `<button onclick="removeFormRow(${formRowCount})" class="text-red-300 text-[9px] font-bold">USU≈É</button>` : ''}</div><input type="text" placeholder="Nazwa" class="chem-name w-full border p-2 rounded text-sm outline-none text-black" value="${data ? data.name : ''}"><div class="grid grid-cols-2 gap-2 text-black"><input type="text" placeholder="Grupa (np. II-4/31)" class="chem-group border p-2 rounded text-sm text-black" value="${data ? data.group : ''}"><input type="text" placeholder="Zastosowanie" class="chem-usage border p-2 rounded text-sm text-black" value="${data ? data.usage : ''}"></div><div class="grid grid-cols-2 gap-2 text-black"><div><label class="text-[8px] font-bold text-gray-400 uppercase">Przyjƒôcie:</label><input type="date" class="chem-received border p-2 rounded text-sm w-full text-black" value="${data ? data.received : today}"></div><div><label class="text-[8px] font-bold text-red-300 uppercase">Wa≈ºno≈õƒá:</label><input type="date" class="chem-expiry border p-2 rounded text-sm w-full text-black" value="${data ? data.expiry : ''}"></div></div>`;
            container.appendChild(row);
        };
        window.removeFormRow = (id) => { document.getElementById(`formRow_${id}`).remove(); };

        function loadOdczynniki() {
            onSnapshot(query(collection(db, 'odczynniki'), orderBy("timestamp", "asc")), (snap) => {
                odczynnikiCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderOdczynniki();
            });
        }

        function renderOdczynniki() {
            const container = document.getElementById('chemicalListGrouped');
            container.innerHTML = ""; const ab = document.getElementById('alertBox'); ab.innerHTML = "";
            const filtered = odczynnikiCache.filter(item => (item.category || 'Wzorce') === currentOdczynnikiSubTab || (currentOdczynnikiSubTab === 'Wzorce' && item.category === 'Standardowe'));
            const businessDaysThreshold = (currentOdczynnikiSubTab === 'Odczynniki') ? 60 : 30;
            const groups = filtered.reduce((acc, item) => {
                const prefix = (item.group || 'Inne').split('/')[0];
                if (!acc[prefix]) acc[prefix] = { prefix, items: [], name: item.name };
                acc[prefix].items.push(item); return acc;
            }, {});
            const sortedKeys = Object.keys(groups).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
            let groupLP = 1, groupAlerts = [];
            sortedKeys.forEach(key => {
                const group = groups[key];
                const groupCard = document.createElement('div');
                groupCard.className = "bg-white rounded-xl border shadow-sm mb-3 overflow-hidden text-black";
                group.items.sort((a, b) => a.group.localeCompare(b.group, undefined, { numeric: true }));
                const expiringItems = group.items.filter(item => {
                    if (!item.expiry) return false;
                    const bDays = calculateBusinessDays(new Date(), new Date(item.expiry));
                    return bDays !== -1 && bDays <= businessDaysThreshold;
                });
                const backupItems = group.items.filter(item => {
                    if (!item.expiry) return false;
                    const bDays = calculateBusinessDays(new Date(), new Date(item.expiry));
                    return bDays > businessDaysThreshold;
                });
                if (expiringItems.length > 0) {
                    if (backupItems.length > 0) {
                        const bestBackup = backupItems.sort((a,b) => new Date(b.expiry) - new Date(a.expiry))[0];
                        groupAlerts.push({ prefix: group.prefix, name: group.name, type: 'backup', date: bestBackup.expiry });
                    } else {
                        const anyOrdered = expiringItems.some(i => i.ordered);
                        const soonestExpiry = expiringItems.sort((a, b) => new Date(a.expiry) - new Date(b.expiry))[0].expiry;
                        groupAlerts.push({ prefix: group.prefix, name: group.name, type: anyOrdered ? 'ordered' : 'warning', date: soonestExpiry });
                    }
                }
                let itemsHtml = group.items.map(item => {
                    const bDays = item.expiry ? calculateBusinessDays(new Date(), new Date(item.expiry)) : null;
                    const dCol = (bDays === -1) ? "text-red-600 font-bold" : ((bDays !== null && bDays <= businessDaysThreshold) ? "text-orange-500 font-bold" : "text-black font-semibold");
                    const suffix = item.group.includes('/') ? '/' + item.group.split('/')[1] : '‚Ä¢';
                    return `<div class="${item.ordered ? 'ordered-row' : ''} flex items-center justify-between p-3 border-t text-[11px] text-black"><div class="flex items-center gap-3"><span class="font-black text-blue-400 w-8">${suffix}</span><div class="flex flex-col text-black"><span class="uppercase">Wa≈ºno≈õƒá: <span class="${dCol}">${item.expiry || '--'}</span> <span class="text-[8px] text-gray-400">(${bDays !== -1 ? bDays + ' d.rob' : 'PO TERMINIE'})</span></span><span class="text-[8px] italic text-gray-500">${item.usage || ''}</span></div></div><div class="flex gap-4"><button onclick="toggleOrder('${item.id}', ${item.ordered})">${item.ordered ? '‚úÖ' : 'üõí'}</button><button onclick="startEdit('${item.id}', \`${item.name}\`, \`${item.group}\`, \`${item.usage}\`, '${item.expiry}', '${item.received}')">‚úèÔ∏è</button><button onclick="deleteItem('${item.id}')">‚úï</button></div></div>`;
                }).join('');
                groupCard.innerHTML = `<div class="bg-gray-100 px-4 py-2 border-b flex items-center gap-3"><span class="bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">LP ${groupLP}</span><div class="flex items-center gap-2 overflow-hidden text-black"><span class="font-black uppercase text-xs truncate">${group.name}</span><span class="font-bold text-gray-500 text-[10px] uppercase border-l pl-2 leading-none border-gray-300">${group.prefix}</span></div></div>${itemsHtml}`;
                container.appendChild(groupCard);
                groupLP++;
            });
            if (groupAlerts.length > 0) {
                ab.innerHTML = groupAlerts.map(a => {
                    if (a.type === 'backup') return `<div class="bg-green-50 border border-green-200 text-green-800 p-2 rounded shadow-sm flex items-center gap-2 font-bold"><span class="text-[14px]">üõ°Ô∏è</span><span>[${a.prefix}] ${a.name} - Jest drugi zapasowy wzorzec/odczynnik (Wa≈ºny do: ${a.date})</span></div>`;
                    if (a.type === 'ordered') return `<div class="bg-green-100 border border-green-200 text-green-800 p-2 rounded shadow-sm flex items-center gap-2 font-bold"><span class="text-[14px]">‚úÖ</span><span>[${a.prefix}] ${a.name} - ZAM√ìWIONO</span></div>`;
                    return `<div class="bg-orange-100 border border-orange-200 text-orange-800 p-2 rounded shadow-sm flex items-center gap-2 font-bold"><span class="text-[14px]">‚ö†Ô∏è</span><span>[${a.prefix}] ${a.name} - <span class="underline">Wa≈ºny do: ${a.date}</span></span></div>`;
                }).join('');
                ab.classList.remove('hidden');
            } else ab.classList.add('hidden');
        }

        window.addItem = async () => {
            const rows = document.getElementById('dynamicItemsContainer').children;
            const items = [];
            for (let row of rows) {
                const name = row.querySelector('.chem-name').value.trim();
                if (name) items.push({ name, group: row.querySelector('.chem-group').value.trim(), usage: row.querySelector('.chem-usage').value.trim(), received: row.querySelector('.chem-received').value, expiry: row.querySelector('.chem-expiry').value, timestamp: Date.now() + items.length, ordered: false, category: currentOdczynnikiSubTab });
            }
            if (!items.length) return alert("Podaj nazwƒô!");
            for (let item of items) await addDoc(collection(db, 'odczynniki'), item);
            cancelEdit();
        };

        window.startEdit = (id, n, g, u, e, r) => {
            document.getElementById('editId').value = id; document.getElementById('dynamicItemsContainer').innerHTML = ""; formRowCount = 0;
            addFormRow({ name: n, group: g, usage: u, expiry: e, received: r });
            document.getElementById('formContainer').classList.add('editing-mode'); document.getElementById('cancelEditBtn').classList.remove('hidden'); document.getElementById('submitBtn').innerText = "Zaktualizuj wybranƒÖ butelkƒô";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        window.cancelEdit = () => { document.getElementById('editId').value = ""; document.getElementById('formContainer').classList.remove('editing-mode'); document.getElementById('cancelEditBtn').classList.add('hidden'); document.getElementById('submitBtn').innerText = "Zapisz wszystko"; document.getElementById('dynamicItemsContainer').innerHTML = ""; formRowCount = 0; addFormRow(); };
        window.toggleOrder = async (id, s) => await updateDoc(doc(db, 'odczynniki', id), { ordered: !s });
        window.deleteItem = async (id) => { if(confirm("UsunƒÖƒá?")) await deleteDoc(doc(db, 'odczynniki', id)); };

        window.switchSubTab = (lab, target) => {
            ['Archiwalna', 'Slepa', 'Probkobranie', 'Porownania'].forEach(cat => {
                const c = document.getElementById(`subContent${lab.charAt(0).toUpperCase() + lab.slice(1)}${cat}`);
                const b = document.getElementById(`subBtn${lab.charAt(0).toUpperCase() + lab.slice(1)}${cat}`);
                if(c) c.classList.add('hidden');
                if(b) b.className = `px-2 py-2 border rounded text-[9px] font-bold uppercase bg-white text-gray-500 text-center min-w-[120px]`;
            });
            document.getElementById(`subContent${lab.charAt(0).toUpperCase() + lab.slice(1)}${target}`).classList.remove('hidden');
            document.getElementById(`subBtn${lab.charAt(0).toUpperCase() + lab.slice(1)}${target}`).className = `px-2 py-2 border rounded text-[9px] font-bold uppercase active-sub-tab-${lab} text-center min-w-[120px]`;
        };
        function loadTasks() {
            onSnapshot(query(collection(db, 'harmonogram'), orderBy("timestamp", "asc")), (snap) => {
                const labs = ['woda', 'scieki'], cats = ['Archiwalna', 'Slepa', 'Probkobranie', 'Porownania'], stats = {};
                labs.forEach(l => cats.forEach(c => { const id = `taskList${l.charAt(0).toUpperCase() + l.slice(1)}${c}`; if(document.getElementById(id)) document.getElementById(id).innerHTML = ""; stats[`${l}${c}`] = { t:0, d:0, m:false }; }));
                const curY = new Date().getFullYear(), curM = new Date().getMonth();
                snap.docs.forEach(dSnap => {
                    const t = dSnap.data(), dDate = t.doneDate ? new Date(t.doneDate) : null, isY = dDate && dDate.getFullYear() === curY, isM = isY && dDate.getMonth() === curM, key = `${t.lab}${t.category}`;
                    if(stats[key]) { stats[key].t++; if(isY) stats[key].d++; if(isM) stats[key].m = true; }
                    const div = document.createElement('div'); div.className = `flex justify-between items-center p-3 border rounded-lg ${isY ? 'task-done' : 'bg-white shadow-sm'} mb-2 text-[11px] text-black`;
                    div.innerHTML = `<div class="flex flex-col"><span class="font-bold text-black">${t.name}</span>${isY ? `<span class="text-[9px] text-green-600 font-bold uppercase mt-1">Wykonano: ${t.doneDate}</span>` : ''}</div><div class="flex gap-4"><button onclick="toggleTask('${dSnap.id}', ${isY})" class="text-xl">${isY ? '‚úÖ' : '‚¨ú'}</button><button onclick="deleteTask('${dSnap.id}')">‚úï</button></div>`;
                    const listEl = document.getElementById(`taskList${t.lab.charAt(0).toUpperCase() + t.lab.slice(1)}${t.category}`); if(listEl) listEl.appendChild(div);
                });
                Object.keys(stats).forEach(key => {
                    const mEl = document.getElementById(`mStatus${key.charAt(0).toUpperCase() + key.slice(1)}`), yEl = document.getElementById(`yStatus${key.charAt(0).toUpperCase() + key.slice(1)}`), s = stats[key];
                    if(!mEl || !yEl) return;
                    mEl.className = "p-2 rounded-lg text-[9px] font-bold border text-center mb-1 " + (s.m ? "bg-green-50 text-green-700" : "bg-orange-50 text-orange-800 animate-pulse");
                    mEl.innerHTML = s.m ? "‚úÖ Wykonano w tym miesiƒÖcu" : "‚ö†Ô∏è Brak zadania w tym miesiƒÖcu!";
                    yEl.className = "p-2 rounded-lg text-[9px] font-bold border text-center mb-2 bg-gray-50 text-gray-500 uppercase";
                    yEl.innerHTML = (s.d === s.t && s.t > 0) ? "‚≠ê Plan roczny zako≈Ñczony!" : `Plan Roczny: ${s.d} / ${s.t} ZROBIONE`;
                });
            });
        }
        window.addTask = async (lab, cat) => { const input = document.getElementById(`taskInput${lab.charAt(0).toUpperCase() + lab.slice(1)}${cat}`); if(input.value.trim()) { await addDoc(collection(db, 'harmonogram'), { name: input.value.trim(), lab, category: cat, doneDate: null, timestamp: Date.now() }); input.value = ""; } };
        window.toggleTask = async (id, isDone) => { await updateDoc(doc(db, 'harmonogram', id), { doneDate: isDone ? null : new Date().toISOString().split('T')[0] }); };
        window.deleteTask = async (id) => { if(confirm("UsunƒÖƒá?")) await deleteDoc(doc(db, 'harmonogram', id)); };

        function loadWzorcowanie() { onSnapshot(query(collection(db, 'wzorcowanie'), orderBy("timestamp", "asc")), (snap) => { wzorcowanieCache = snap.docs.map(d => ({ id: d.id, ...d.data() })); updateWzorcowanieUI(); }); }
        function updateWzorcowanieUI() {
            const list = document.getElementById('equipmentList'); if(!list) return;
            const mNames = { "01":"Stycze≈Ñ", "02":"Luty", "03":"Marzec", "04":"Kwiecie≈Ñ", "05":"Maj", "06":"Czerwiec", "07":"Lipiec", "08":"Sierpie≈Ñ", "09":"Wrzesie≈Ñ", "10":"Pa≈∫dziernik", "11":"Listopad", "12":"Grudzie≈Ñ" };
            const nav = document.getElementById('monthsNav'); nav.innerHTML = "";
            for(let i=1; i<=12; i++) {
                const id = i.toString().padStart(2, '0'); const btn = document.createElement('button'); btn.innerText = mNames[id].substring(0,3);
                btn.onclick = () => { selectedWMonth = id; updateWzorcowanieUI(); };
                btn.className = `px-3 py-2 border rounded text-[9px] font-bold uppercase ${selectedWMonth === id ? 'active-month' : 'bg-white text-gray-500'}`; nav.appendChild(btn);
            }
            list.innerHTML = ""; let mTotal = 0, mDone = 0, upcoming = [], curY = new Date().getFullYear();
            let dNext = new Date(); dNext.setMonth(dNext.getMonth() + 1); const nextM = (dNext.getMonth() + 1).toString().padStart(2, '0');
            wzorcowanieCache.forEach(eq => {
                const isY = eq.doneDate && new Date(eq.doneDate).getFullYear() === curY;
                if ((eq.type === "Wzorcowanie" || !eq.type) && eq.month === nextM && !isY) upcoming.push(eq.name);
                if (eq.month === selectedWMonth) {
                    mTotal++; if(isY) mDone++;
                    let colorClass = "bg-purple-100 text-purple-700";
                    if(eq.type === "Kalibracja") colorClass = "bg-blue-100 text-blue-700";
                    else if(eq.type === "Sprawdzenie") colorClass = "bg-green-100 text-green-700";
                    const div = document.createElement('div'); div.className = `flex justify-between items-center p-3 border rounded-lg ${isY ? 'task-done' : 'bg-white shadow-sm'} mb-2 text-[11px] text-black`;
                    div.innerHTML = `<div><span class="${colorClass} px-1 rounded text-[8px] uppercase mr-2 font-bold">${eq.type || 'WZORCOWANIE'}</span><span class="font-bold text-black">${eq.name}</span></div><div class="flex gap-3"><button onclick="toggleEquip('${eq.id}', ${isY})" class="text-xl">${isY ? '‚úÖ' : '‚¨ú'}</button><button onclick="deleteEquip('${eq.id}')">‚úï</button></div>`;
                    list.appendChild(div);
                }
            });
            document.getElementById('monthlyWzorcowanieCounter').innerText = `${mNames[selectedWMonth]}: ${mDone} z ${mTotal} zrobione`;
            const abEq = document.getElementById('upcomingWzorcowanieAlert'); 
            if (upcoming.length > 0) { abEq.innerHTML = `üì¢ PLANOWANE WZORCOWANIA NA ${mNames[nextM]}: ${upcoming.join(', ')}`; abEq.classList.remove('hidden'); } else { abEq.classList.add('hidden'); }
        }
        window.addEquipment = async () => { const n = document.getElementById('equipName'), m = document.getElementById('equipMonth'), t = document.getElementById('equipType'); if(n.value.trim()) { await addDoc(collection(db, 'wzorcowanie'), { name: n.value.trim(), month: m.value, type: t.value, doneDate: null, timestamp: Date.now() }); n.value = ""; } };
        window.toggleEquip = async (id, isDone) => { await updateDoc(doc(db, 'wzorcowanie', id), { doneDate: isDone ? null : new Date().toISOString().split('T')[0] }); };
        window.deleteEquip = async (id) => { if(confirm("UsunƒÖƒá?")) await deleteDoc(doc(db, 'wzorcowanie', id)); };

        window.changeMonth = (v) => { calDate.setMonth(calDate.getMonth() + v); renderCalendar(); };
        window.selectDay = (d) => { selectedDayStr = d; renderCalendar(); updateDayEvents(); };
        window.openAddEvent = async () => { const t = prompt("Nazwa wydarzenia:"); if(t) await addDoc(collection(db, 'wydarzenia'), { title: t.trim(), date: selectedDayStr, timestamp: Date.now() }); };
        window.deleteEvent = async (id) => { if(confirm("UsunƒÖƒá?")) await deleteDoc(doc(db, 'wydarzenia', id)); };
        function renderCalendar() {
            const grid = document.getElementById('calendarDays'), label = document.getElementById('calendarMonthYear'), mNames = ["Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec", "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"];
            label.innerText = `${mNames[calDate.getMonth()]} ${calDate.getFullYear()}`; grid.innerHTML = "";
            const fDay = new Date(calDate.getFullYear(), calDate.getMonth(), 1).getDay(), dInM = new Date(calDate.getFullYear(), calDate.getMonth() + 1, 0).getDate(), offset = fDay === 0 ? 6 : fDay - 1;
            for(let i=0; i<offset; i++) grid.innerHTML += `<div class="calendar-day opacity-0"></div>`;
            const t = new Date().toISOString().split('T')[0];
            for(let d=1; d<=dInM; d++) {
                const ds = `${calDate.getFullYear()}-${(calDate.getMonth()+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const hasE = eventsCache.some(e => e.date === ds), div = document.createElement('div');
                div.className = `calendar-day ${ds === t ? 'today' : ''} ${ds === selectedDayStr ? 'selected' : ''} ${hasE ? 'has-event' : ''}`;
                div.innerText = d; div.onclick = () => selectDay(ds); grid.appendChild(div);
            }
            updateDayEvents(); updateMonthEvents();
        }
        function updateDayEvents() {
            const list = document.getElementById('dayEventsList'); document.getElementById('selectedDateLabel').innerText = `Dzie≈Ñ: ${selectedDayStr}`;
            const f = eventsCache.filter(e => e.date === selectedDayStr);
            list.innerHTML = f.length ? f.map(e => `<div class="flex justify-between bg-white p-2 rounded shadow-sm text-[11px] font-semibold text-black"><span>${e.title}</span><button onclick="deleteEvent('${e.id}')" class="text-red-300">‚úï</button></div>`).join('') : `<p class="text-[10px] text-gray-400 italic">Brak wydarze≈Ñ.</p>`;
        }
        function updateMonthEvents() {
            const list = document.getElementById('monthEventsList'), mStr = `${calDate.getFullYear()}-${(calDate.getMonth() + 1).toString().padStart(2, '0')}`;
            const f = eventsCache.filter(e => e.date.startsWith(mStr)).sort((a,b) => a.date.localeCompare(b.date));
            list.innerHTML = f.length ? f.map(e => `<div class="flex justify-between items-center bg-white p-2 rounded border-l-4 border-blue-400 shadow-sm text-[10px] mb-1 text-black font-bold"><span><span class="text-blue-600">${e.date.split('-')[2]}</span> ${e.title}</span><button onclick="deleteEvent('${e.id}')" class="text-gray-300">‚úï</button></div>`).join('') : `<p class="text-[10px] text-gray-400 italic">Brak wydarze≈Ñ w miesiƒÖcu.</p>`;
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden'); document.getElementById('appSection').classList.remove('hidden');
                formRowCount = 0; document.getElementById('dynamicItemsContainer').innerHTML = ""; addFormRow();
                loadOdczynniki(); loadTasks(); loadWzorcowanie();
                onSnapshot(query(collection(db, 'wydarzenia'), orderBy("timestamp", "asc")), (snap) => { eventsCache = snap.docs.map(d => ({ id: d.id, ...d.data() })); renderCalendar(); });
            } else { document.getElementById('loginSection').classList.remove('hidden'); document.getElementById('appSection').classList.add('hidden'); }
        });
        window.handleLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); } catch(err) { alert("B≈ÇƒÖd!"); } };
        window.handleLogout = async () => { await signOut(auth); location.reload(); };
    </script>
</body>
</html>
